<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-Physicist Dashboard | DietNotify</title>
    <link rel="icon" type="image/svg+xml" href="/static/img/logo.svg">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK for Push Notifications (v10.13.2) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-messaging-compat.js"></script>
    <script src="/static/js/notification_manager.js?v=16" defer></script>
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    <script src="/static/js/clinic_manager.js" defer></script>
    <style>
        /* V4 ULTRA-MODERN DASHBOARD - Charts & Bullet Points Focus */
        :root {
            /* Inherit global variables from style.css */
            --sidebar-width: 280px;

            /* Accent Mapping to Global Branding */
            --accent-primary: #0891b2;
            /* Teal */
            --accent-secondary: #facc15;
            /* Yellow */
            --accent-tertiary: #a855f7;
            /* Purple */
            --accent-pink: #db2777;
            --accent-yellow: var(--brand-yellow);
            --accent-red: #dc2626;

            /* Light Mode Backgrounds */
            --bg-primary: #f4f4f5;
            --bg-card: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: #e4e4e7;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-primary);
            font-family: 'Outfit', sans-serif;
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            /* Prevent body scroll */
            display: flex;
        }

        /* Animated Background */
        .bg-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            background: linear-gradient(rgba(244, 244, 245, 0.94), rgba(244, 244, 245, 0.88)),
                url('/static/img/scientific_bg.png');
            background-size: cover;
            background-position: center;
        }

        .mesh-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
            animation: meshFloat 25s ease-in-out infinite;
        }

        .blob-1 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
            top: -150px;
            right: -100px;
        }

        .blob-2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent-secondary) 0%, transparent 70%);
            bottom: -150px;
            left: 20%;
            animation-delay: -8s;
        }

        @keyframes meshFloat {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            50% {
                transform: translate(30px, -30px) scale(1.1);
            }
        }

        /* SCIENTIFIC GRID OVERLAY */
        .overlay-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1300;
            /* Increased z-index to be above mobile-header and bottom-nav */
            display: flex;
            flex-direction: column;
            padding: 25px 15px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .sidebar-brand {
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .nav-menu {
            list-style: none;
            flex: 1;
            overflow-y: auto;
            /* Scroll if content is too tall */
            padding-right: 5px;
            /* Space for scrollbar */
            margin-right: -5px;
            /* Align with edge */
        }

        /* Sidebar Scrollbar */
        .nav-menu::-webkit-scrollbar {
            width: 4px;
        }

        .nav-menu::-webkit-scrollbar-track {
            background: transparent;
        }

        .nav-menu::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .nav-menu:hover::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            margin-bottom: 8px;
            border-radius: 14px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            transform: translateX(5px);
        }

        .nav-link.active {
            background: var(--gradient-main);
            color: #000;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .nav-regen {
            margin-top: auto;
        }

        .nav-regen .nav-link {
            background: rgba(255, 0, 100, 0.1);
            border: 1px solid rgba(255, 0, 100, 0.3);
            color: #ff6b9d;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            /* Independent scroll */
            padding: 35px 40px 180px;
            /* Extra bottom padding for mobile nav */
            position: relative;
            z-index: 1;
            scroll-behavior: smooth;
        }

        /* PREMIUM CUSTOM SCROLLBAR for right pane */
        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.05);
            /* Subtle thumb */
            border-radius: 10px;
            transition: background 0.3s;
        }

        .main-content:hover::-webkit-scrollbar-thumb {
            background: rgba(22, 163, 74, 0.2);
            /* Green glow on hover */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* CARD ENTRANCE ANIMATION */
        .glass-card {
            animation: cardEntrance 0.8s cubic-bezier(0.16, 1, 0.3, 1) backwards;
        }

        @keyframes cardEntrance {
            from {
                opacity: 0;
                transform: scale(0.98) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Staggered card animations */
        .glass-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .glass-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .glass-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .glass-card:nth-child(4) {
            animation-delay: 0.4s;
        }

        /* SECTION HEADER */
        .section-header {
            margin-bottom: 35px;
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 60px;
            height: 4px;
            background: var(--gradient-main);
            border-radius: 2px;
        }

        /* Ensure sections have enough bottom padding for mobile nav */
        #overview,
        #analysis,
        #meals,
        #progress,
        #experts {
            padding-bottom: 100px;
        }

        .section-header h1 {
            font-size: clamp(2.2rem, 5vw, 3.5rem);
            font-weight: 900;
            letter-spacing: -2px;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            line-height: 1.1;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: clamp(1rem, 1.5vw, 1.15rem);
            max-width: 650px;
            line-height: 1.6;
            font-weight: 500;
        }

        /* STAT CARDS ROW */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-primary);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 900;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* GRID LAYOUTS */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 25px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 25px;
        }

        /* GLASS CARDS */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 28px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(0, 255, 136, 0.3);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-header i {
            font-size: 1.4rem;
            color: var(--accent-primary);
        }

        .card-header h3 {
            font-size: 1.15rem;
            font-weight: 700;
        }

        .bullet-content ul li::before {
            content: '→';
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-weight: 900;
        }

        /* PREMIUM MEAL CARDS REDESIGN */
        .meal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .meal-card {
            position: relative;
            min-height: 420px;
            border-radius: 32px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            background-size: cover;
            background-position: center;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .meal-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }

        .meal-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 30%, rgba(0, 0, 0, 0.7) 100%);
            z-index: 1;
        }

        .meal-card-content {
            position: relative;
            z-index: 2;
            padding: 30px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            margin: 15px;
            border-radius: 24px;
            transition: all 0.4s ease;
        }

        .meal-card:hover .meal-card-content {
            background: rgba(255, 255, 255, 0.92);
            transform: translateY(-5px);
        }

        .meal-time-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--accent-primary);
            color: white;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 800;
            z-index: 3;
            box-shadow: 0 10px 20px rgba(22, 163, 74, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .meal-name {
            font-size: clamp(1.2rem, 2vw, 1.4rem);
            font-weight: 900;
            margin-bottom: 12px;
            color: var(--text-primary);
            line-height: 1.2;
        }

        /* BIO LOGIC FLOWCHART */
        .flow-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 20px;
            margin-top: 25px;
            position: relative;
            max-width: 100%;
            overflow-x: auto;
            padding: 10px 5px 25px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) transparent;
        }

        .flow-container::-webkit-scrollbar {
            height: 6px;
        }

        .flow-container::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
        }

        .flow-step {
            flex: 1;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }

        .flow-step:not(:last-child)::after {
            content: '➜';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--accent-primary);
            z-index: 2;
        }

        .flow-step .phase {
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
            background: #eee;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .flow-step .trigger {
            font-weight: 800;
            font-size: 1.05rem;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: block;
        }

        .flow-step .process {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-style: italic;
            margin-bottom: 10px;
            display: block;
        }

        .flow-step .outcome {
            background: rgba(22, 163, 74, 0.1);
            color: var(--accent-primary);
            font-weight: 700;
            font-size: 0.85rem;
            padding: 10px;
            border-radius: 14px;
            display: block;
            margin-top: auto;
        }

        @media (max-width: 768px) {
            .flow-container {
                flex-direction: column;
                overflow-x: hidden;
            }

            .flow-step {
                min-width: 0;
            }

            .flow-step:not(:last-child)::after {
                content: '▼';
                right: 50%;
                bottom: -25px;
                top: auto;
                transform: translateX(50%);
            }
        }

        /* CHART CONTAINERS */
        .chart-container {
            height: 280px;
            width: 100%;
        }

        .chart-container-sm {
            height: 200px;
            width: 100%;
        }

        .chart-container-lg {
            height: 350px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 220px;
            }

            .chart-container-sm {
                height: 180px;
            }

            .chart-container-lg {
                height: 260px;
            }
        }

        /* MEAL CARDS */
        .meal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .meal-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .meal-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(22, 163, 74, 0.1);
        }

        /* METABOLIC SCORE BADGE */
        .metabolic-badge {
            background: rgba(22, 163, 74, 0.1);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .meal-image-container {
            width: 100%;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            background: #eee;
            position: relative;
        }

        .meal-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .meal-card:hover .meal-image-container img {
            transform: scale(1.1);
        }

        .macro-container {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        /* MILESTONE TIMELINE */
        .milestone-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            border-left: 4px solid var(--accent-primary);
        }

        .milestone-week {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--accent-secondary);
            min-width: 60px;
        }

        .milestone-icon {
            font-size: 1.5rem;
        }

        .milestone-text {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* HYDRATION SCHEDULE */
        .hydration-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .hydration-item {
            text-align: center;
            padding: 20px 10px;
            background: rgba(0, 212, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .hydration-item .amount {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-secondary);
        }

        .hydration-item .time {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* QUICK TIPS */
        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .tip-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            border: 1px solid var(--glass-border);
        }

        .tip-card .icon {
            font-size: 1.5rem;
        }

        .tip-card .text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* CHECKLIST */
        .checklist {
            list-style: none;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .checklist-item .day {
            min-width: 90px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .checklist-item .task {
            flex: 1;
            color: var(--text-secondary);
        }

        .priority-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .priority-badge.high {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .priority-badge.medium {
            background: rgba(255, 217, 61, 0.2);
            color: #ffd93d;
        }

        /* ERROR BANNER */
        #errorBanner {
            background: rgba(255, 77, 109, 0.1);
            color: #ff6b8a;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 77, 109, 0.2);
            margin-bottom: 25px;
            display: none;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                padding: 15px 10px;
            }

            .sidebar-brand span,
            .nav-link span:not(.nav-icon) {
                display: none;
            }

            /* User explicitly asked for full names, so let's show them on hover for tablets */
            .sidebar:hover {
                width: var(--sidebar-width);
                padding: 25px 15px;
            }

            .sidebar:hover .sidebar-brand span,
            .sidebar:hover .nav-link span:not(.nav-icon) {
                display: inline;
            }

            .nav-link {
                justify-content: center;
                padding: 14px;
            }

            .sidebar:hover .nav-link {
                justify-content: flex-start;
                padding: 16px 20px;
            }

            .main-content {
                margin-left: 70px;
                padding: 25px;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .hydration-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }

            .mobile-header {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 60px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(25px);
                z-index: 1100;
                align-items: center;
                justify-content: space-between;
                /* Space out items */
                padding: 0 15px;
                border-bottom: 1px solid var(--glass-border);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            }

            .hamburger-menu {
                display: flex !important;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                cursor: pointer;
                z-index: 1200;
                margin-right: 10px;
                background: rgba(22, 163, 74, 0.1);
                border-radius: 12px;
                color: var(--accent-primary);
                font-size: 1.2rem;
                transition: all 0.3s ease;
            }

            .hamburger-menu.active {
                transform: rotate(180deg);
                background: var(--accent-primary);
                color: white;
            }

            .sidebar {
                transform: translateX(-100%);
                visibility: hidden;
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.1);
                width: 280px !important;
                /* Force width on mobile */
                z-index: 1500;
                transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }

            .sidebar.active {
                transform: translateX(0);
                visibility: visible;
                display: flex !important;
            }

            .sidebar.active .sidebar-brand span,
            .sidebar.active .nav-link span:not(.nav-icon),
            .sidebar.active #notificationLabel {
                display: inline !important;
            }

            .sidebar.active .nav-link {
                justify-content: flex-start !important;
                padding: 16px 20px !important;
            }

            .sidebar.active .nav-menu {
                gap: 15px;
                /* Add some breathing room on mobile */
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(4px);
                z-index: 1450;
                display: none;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0;
                margin-top: 100px;
                /* Increased to avoid header overlap */
                height: calc(100vh - 170px);
                /* Adjust for larger header margin + bottom nav */
                /* Adjust for header + bottom nav + extra margin */
                overflow-y: auto;
                padding: 20px 15px;
                scroll-behavior: smooth;
            }

            .section-header {
                padding-top: 10px;
            }

            .section-header h1 {
                font-size: 2rem;
                letter-spacing: -1px;
            }

            /* BOTTOM NAVIGATION */
            .bottom-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 70px;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-top: 1px solid var(--glass-border);
                z-index: 1200;
                justify-content: space-around;
                align-items: center;
                padding: 0 10px;
                box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.05);
            }

            .bottom-nav-link {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                color: var(--text-muted);
                text-decoration: none;
                font-size: 0.7rem;
                font-weight: 700;
                text-transform: uppercase;
                transition: all 0.3s ease;
                flex: 1;
            }

            .bottom-nav-link i {
                font-size: 1.2rem;
            }

            .bottom-nav-link.active {
                color: var(--accent-primary);
            }

            .bottom-nav-link.active i {
                transform: translateY(-2px);
                text-shadow: 0 5px 15px rgba(22, 163, 74, 0.3);
            }

            /* Better Card Responsiveness */
            .glass-card {
                padding: 20px;
                margin-bottom: 15px;
            }

            .card-header h3 {
                font-size: 1rem;
            }
        }

        /* EXTRA SMALL DEVICES */
        @media (max-width: 480px) {
            .stats-row {
                display: flex !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory;
                gap: 15px;
                padding: 10px 5px 25px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .stats-row::-webkit-scrollbar {
                display: none;
            }

            .stat-card {
                flex: 0 0 calc(100% - 40px);
                scroll-snap-align: center;
                margin-bottom: 0 !important;
            }

            .meal-grid {
                display: flex !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory;
                gap: 20px;
                padding: 10px 5px 30px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .meal-grid::-webkit-scrollbar {
                display: none;
            }

            .meal-card {
                flex: 0 0 calc(100% - 20px);
                scroll-snap-align: center;
                min-height: 420px;
            }

            /* Swiper Controls */
            .swiper-wrapper {
                position: relative;
                width: 100%;
                overflow: visible;
            }

            .swiper-arrow {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                width: 40px;
                height: 40px;
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 50%;
                display: none;
                /* Hidden by default, shown by JS */
                align-items: center;
                justify-content: center;
                color: var(--text-primary);
                z-index: 100;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                transition: opacity 0.3s ease, transform 0.2s ease;
            }

            .swiper-arrow:active {
                transform: translateY(-50%) scale(0.9);
            }

            .swiper-arrow.prev {
                left: 5px;
            }

            .swiper-arrow.next {
                right: 5px;
            }

            .stat-value {
                font-size: 1.4rem;
            }

            .grid-2 {
                gap: 15px;
            }

            .chart-container {
                height: 350px;
                /* Increased for mobile visibility */
            }

            .chart-container-lg {
                height: 400px;
                /* More room for progress charts */
            }

            .meal-grid {
                grid-template-columns: 1fr;
            }

            .meal-card {
                min-height: 400px;
            }

            .section-header {
                margin-bottom: 25px;
            }

            .section-header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .glass-card {
                padding: 15px;
                border-radius: 20px;
            }
        }

        /* NOTIFICATION TOGGLE - Premium Styles */
        .notification-nav-item {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }

        .notification-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(245, 245, 245, 0.9));
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .notification-toggle-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(22, 163, 74, 0.15);
            border-color: rgba(22, 163, 74, 0.2);
        }

        .notification-toggle-container.enabled {
            background: linear-gradient(135deg, #0891b2, #22d3ee);
            border-color: #0891b2;
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
        }

        .notification-toggle-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-icon-wrapper {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .notification-icon-wrapper i {
            font-size: 16px;
            color: #6b7280;
            transition: all 0.3s ease;
        }

        .notification-toggle-container.enabled .notification-icon-wrapper {
            background: linear-gradient(135deg, #0891b2, #22d3ee);
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.35);
        }

        .notification-toggle-container.enabled .notification-icon-wrapper i {
            color: white;
        }

        #notificationLabel {
            font-size: 0.9rem;
            font-weight: 700;
            color: #374151;
            transition: color 0.3s ease;
        }

        .notification-toggle-container.enabled #notificationLabel {
            color: #0891b2;
        }

        /* Toggle Switch */
        .notification-switch-track {
            width: 44px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            position: relative;
            transition: all 0.3s ease;
        }

        .notification-toggle-container.enabled .notification-switch-track {
            background: linear-gradient(135deg, #0891b2, #22d3ee);
        }

        .notification-switch-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .notification-toggle-container.enabled .notification-switch-thumb {
            left: 22px;
        }

        /* Notification Settings Button */
        .notification-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-settings-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-settings-btn:hover {
            background: rgba(22, 163, 74, 0.1);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: rotate(45deg);
        }

        /* Customization Modal Styles */
        .notif-settings-list {
            list-style: none;
            margin-top: 20px;
        }

        .notif-settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .notif-settings-meal-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notif-settings-meal-icon {
            font-size: 1.2rem;
            color: var(--accent-primary);
        }

        .notif-settings-meal-name {
            font-weight: 600;
        }

        .notif-time-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 10px;
            font-family: inherit;
            font-weight: 700;
            outline: none;
            transition: all 0.3s ease;
        }

        .notif-time-input:focus {
            border-color: var(--accent-primary);
            background: rgba(22, 163, 74, 0.1);
        }

        /* USER LOCATION MARKER (PULSING DOT) */
        .user-marker-pulse {
            width: 20px;
            height: 20px;
            background-color: #0ea5e9;
            border: 3px solid #ffffff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
            animation: pulse-ring 2s infinite;
            cursor: pointer;
        }

        /* MAP MODE TOGGLE (Satellite/Standard) */
        .map-mode-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 5px;
            border-radius: 12px;
            display: flex;
            gap: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 101;
            border: 1px solid var(--glass-border);
        }

        .map-mode-toggle button {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-mode-toggle button.active {
            background: var(--accent-primary);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(14, 165, 233, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);
            }
        }

        /* LOCATE ME BUTTON */
        .map-locate-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ffffff;
            color: var(--accent-primary);
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .map-locate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            background: var(--accent-primary);
            color: #ffffff;
        }

        /* FIXED NOTIFICATION TOGGLE FOR NARROW SIDEBAR */
        .notification-toggle-wrapper {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
            overflow: hidden;
        }

        .notification-toggle-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            min-width: 0;
        }

        @media (max-width: 992px) {

            .sidebar:not(:hover) .notification-label,
            .sidebar:not(:hover) #notificationLabel,
            .sidebar:not(:hover) .notification-switch {
                display: none;
            }

            .sidebar:not(:hover) .notification-toggle-container {
                justify-content: center;
                padding: 10px 0;
            }

            .sidebar:not(:hover) .notification-settings-btn {
                display: none;
            }
        }


        /* MODAL OVERLAY - Fix for Auto-Appearance */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            max-width: 95% !important;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            /* Prevent overflowing screen height */
        }

        /* MOBILE OPTIMIZATIONS FOR MODAL */
        @media (max-width: 480px) {
            .modal {
                padding: 0;
            }

            .modal-content {
                width: 96% !important;
                height: auto !important;
                max-width: 96% !important;
                max-height: 94vh !important;
                margin: 20px auto !important;
                border-radius: 20px !important;
                border: 1px solid var(--glass-border) !important;
            }

            .modal-header {
                flex-shrink: 0;
                /* Keep header visible */
                padding: 20px !important;
            }

            #notifSettingsContent {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                /* Scrollable middle content */
                padding: 10px 12px 80px !important;
                /* Extra bottom padding */
            }

            /* Fix mobile inputs */
            .modal-content input,
            .modal-content select {
                width: 100%;
                box-sizing: border-box;
                min-height: 44px;
            }

            .modal-footer {
                flex-shrink: 0;
                /* Keep footer visible */
                padding: 15px 20px !important;
                background: rgba(255, 255, 255, 0.95);
                /* Opaque bg for buttons */
                border-top: 1px solid rgba(0, 0, 0, 0.05);
                /* Ensure it stays at bottom */
                position: sticky;
                bottom: 0;
                z-index: 10;
            }

            /* Confirm Modal Specifics */
            #confirmModal .modal-content {
                max-width: 350px !important;
                height: auto !important;
                min-height: auto !important;
            }

            #confirmModal .modal-footer {
                flex-direction: row !important;
                gap: 10px;
            }
        }

        /* MAP UI FIX FOR MOBILE - Clean Bottom Sheet */
        @media (max-width: 768px) {
            .map-floating-panel {
                position: absolute !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                top: auto !important;
                width: 100% !important;
                height: auto !important;
                max-height: 40vh !important;
                border-radius: 20px 20px 0 0 !important;
                transform: none !important;
                border-top: 1px solid var(--glass-border);
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
                z-index: 100;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            .map-floating-panel.collapsed {
                transform: translateY(calc(100% - 60px)) !important;
            }

            .expert-list-mini {
                max-height: 30vh !important;
                overflow-y: auto !important;
                padding-bottom: 20px;
            }

            /* Ensure Locate Button is Visible & Positioned correctly */
            .map-locate-btn {
                bottom: 35vh !important;
                /* Position just above the panel when open */
                right: 20px !important;
                z-index: 101 !important;
                transition: bottom 0.3s ease;
            }

            .map-floating-panel.collapsed~.map-locate-btn {
                bottom: 80px !important;
                /* Move down when panel is collapsed */
            }
        }
    </style>
</head>

<body>

    <div class="bg-mesh"></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

    <!-- MOBILE HEADER -->
    <header class="mobile-header" style="display: none;">
        <div class="hamburger-menu" id="hamburgerMenu" onclick="toggleMobileSidebar()">
            <i class="fas fa-chevron-right"></i>
        </div>
        <a href="/index.html" class="brand-wrapper"
            style="margin-right: auto; margin-left: 15px; text-decoration: none; display: flex; align-items: center; gap: 6px;">
            <div class="brand-icon" style="height: 32px; width: 32px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="logo-gradient-dash-mob" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:var(--brand-diet)" />
                            <stop offset="100%" style="stop-color:var(--brand-yellow)" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#logo-gradient-dash-mob)"
                        d="M50 15C30 15 15 35 15 55C15 75 35 85 50 85C65 85 85 75 85 55C85 35 70 15 50 15ZM50 78C35 78 25 68 25 55C25 42 35 32 50 25C65 32 75 42 75 55C75 68 65 78 50 78Z" />
                    <path fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"
                        d="M25 55H40L45 40L55 70L60 55H75" />
                </svg>
            </div>
            <div class="brand-text" style="font-size: 1.1rem; letter-spacing: -0.5px;">
                <span class="text-diet" style="color: var(--brand-diet);">Diet</span><span class="text-notify"
                    style="color: var(--brand-notify);">Notify</span>
            </div>
        </a>
        <div id="headerSectionTitle"
            style="font-size: 0.8rem; font-weight: 800; color: var(--accent-primary); text-transform: uppercase; letter-spacing: 1px;">
            Overview
        </div>
    </header>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <a href="/index.html" class="brand-wrapper sidebar-brand">
            <div class="brand-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="logo-gradient-dash-side" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:var(--brand-diet)" />
                            <stop offset="100%" style="stop-color:var(--brand-yellow)" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#logo-gradient-dash-side)"
                        d="M50 15C30 15 15 35 15 55C15 75 35 85 50 85C65 85 85 75 85 55C85 35 70 15 50 15ZM50 78C35 78 25 68 25 55C25 42 35 32 50 25C65 32 75 42 75 55C75 68 65 78 50 78Z" />
                    <path fill="none" stroke="#ffffff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"
                        d="M25 55H40L45 40L55 70L60 55H75" />
                </svg>
            </div>
            <div class="brand-text">
                <span class="text-diet" style="color: var(--brand-diet);">Diet</span><span class="text-notify"
                    style="color: var(--brand-notify);">Notify</span>
            </div>
        </a>

        <ul class="nav-menu">
            <li><a class="nav-link" href="/index.html">
                    <span class="nav-icon"><i class="fas fa-home"></i></span>
                    <span>Home</span>
                </a></li>
            <li><a class="nav-link" href="/nutrition.html">
                    <span class="nav-icon"><i class="fas fa-leaf"></i></span>
                    <span>Nutrition Engine</span>
                </a></li>
            <li><a class="nav-link active" onclick="showSection('overview', this)">
                    <span class="nav-icon"><i class="fas fa-chart-pie"></i></span>
                    <span>Overview</span>
                </a></li>
            <li><a class="nav-link" onclick="showSection('analysis', this)">
                    <span class="nav-icon"><i class="fas fa-dna"></i></span>
                    <span>Analysis</span>
                </a></li>
            <li><a class="nav-link" onclick="showSection('meals', this)">
                    <span class="nav-icon"><i class="fas fa-utensils"></i></span>
                    <span>Meals</span>
                </a></li>
            <li><a class="nav-link" onclick="showSection('progress', this)">
                    <span class="nav-icon"><i class="fas fa-chart-line"></i></span>
                    <span>Progress</span>
                </a></li>
            <li><a class="nav-link" onclick="showSection('experts', this)">
                    <span class="nav-icon"><i class="fas fa-map-marked-alt"></i></span>
                    <span>Nearby Experts</span>
                </a></li>
            <li><a class="nav-link" href="/about">
                    <span class="nav-icon"><i class="fas fa-info-circle"></i></span>
                    <span>About</span>
                </a></li>
            <li><a class="nav-link" href="/diet/create">
                    <span class="nav-icon"><i class="fas fa-plus"></i></span>
                    <span>Create New Plan</span>
                </a></li>
            <li><a class="nav-link" href="/profile_setup.html">
                    <span class="nav-icon"><i class="fas fa-user-edit"></i></span>
                    <span>Update Profile</span>
                </a></li>
            <!-- NOTIFICATION TOGGLE - Premium Styled -->
            <li id="notificationNavItem" class="notification-nav-item">
                <div class="notification-toggle-wrapper">
                    <div class="notification-toggle-container" id="notificationToggle" onclick="toggleNotifications()">
                        <div class="notification-toggle-left">
                            <div class="notification-icon-wrapper" id="notificationIconWrapper">
                                <i class="fas fa-bell-slash" id="notificationIcon"></i>
                            </div>
                            <span id="notificationLabel">Enable Reminders</span>
                        </div>
                        <div class="notification-switch" id="notificationSwitch">
                            <div class="notification-switch-track">
                                <div class="notification-switch-thumb"></div>
                            </div>
                        </div>
                    </div>
                    <button class="notification-settings-btn" id="openNotifSettingsBtn"
                        onclick="openNotificationSettings()" title="Customize Times">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </li>
            <li class="nav-regen"><a class="nav-link" onclick="savePlan()" id="savePlanBtn"
                    style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); color: #00ff88; display: none;">
                    <span class="nav-icon"><i class="fas fa-save"></i></span>
                    <span>Save Plan</span>
                </a></li>
            <li><a class="nav-link" onclick="logout()" style="color: var(--accent-red); opacity: 0.8;">
                    <span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span>
                    <span>Logout</span>
                </a></li>
        </ul>
    </aside>

    <!-- BOTTOM NAVIGATION (Mobile Only) -->
    <nav class="bottom-nav" style="display: none;">
        <a class="bottom-nav-link active" onclick="showSection('overview', this)">
            <i class="fas fa-chart-pie"></i>
            <span>Overview</span>
        </a>
        <a class="bottom-nav-link" onclick="showSection('analysis', this)">
            <i class="fas fa-dna"></i>
            <span>Analysis</span>
        </a>
        <a class="bottom-nav-link" onclick="showSection('meals', this)">
            <i class="fas fa-utensils"></i>
            <span>Meals</span>
        </a>
        <a class="bottom-nav-link" onclick="showSection('progress', this)">
            <i class="fas fa-chart-line"></i>
            <span>Progress</span>
        </a>
        <a class="bottom-nav-link" onclick="showSection('experts', this)">
            <i class="fas fa-map-marker-alt"></i>
            <span>Experts</span>
        </a>
        <a class="bottom-nav-link" href="/profile_setup.html">
            <i class="fas fa-user-circle"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div id="errorBanner"></div>

        <!-- SECTION 1: OVERVIEW -->
        <section id="overview" class="dashboard-section active">
            <div class="section-header"
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div>
                    <h1>Your Bio-Profile</h1>
                    <p>Personalized metrics and daily targets at a glance</p>
                </div>
                <button class="btn btn-primary" onclick="openPlanSwitcher()"
                    style="border-radius: 50px; font-size: 0.85rem; padding: 10px 20px;">
                    <i class="fas fa-history"></i> <span>Switch Plan</span>
                </button>
            </div>

            <div class="swiper-wrapper">
                <div class="swiper-arrow prev" onclick="scrollSwiper('statsRow', -1)" style="display: none;"><i
                        class="fas fa-chevron-left"></i></div>
                <div class="stats-row" id="statsRow">
                    <!-- Injected via JS -->
                </div>
                <div class="swiper-arrow next" onclick="scrollSwiper('statsRow', 1)" style="display: none;"><i
                        class="fas fa-chevron-right"></i></div>
            </div>

            <!-- Navbar removed from here to use Sidebar -->
            <div class="grid-2">
                <div class="glass-card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie"></i>
                        <h3>Daily Macro Split</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="macroChart"></canvas>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <i class="fas fa-bolt"></i>
                        <h3>Daily Energy Curve</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <i class="fas fa-lightbulb"></i>
                    <h3>Quick Tips</h3>
                </div>
                <div class="tips-grid" id="tipsGrid">
                    <!-- Injected via JS -->
                </div>
            </div>

            <div class="glass-card" style="margin-top: 25px; border-left: 5px solid var(--accent-secondary);">
                <div class="card-header">
                    <i class="fas fa-microscope" style="color: var(--accent-secondary);"></i>
                    <h3>Computational Logic & Reasoning</h3>
                </div>
                <div id="aiReasoning"
                    style="font-size: 1.1rem; line-height: 1.7; color: var(--text-secondary); font-style: italic; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word;">
                    Initiating Deep Analysis Protocol...
                </div>
            </div>

            <!-- NEW SECTION: METABOLIC LOGIC FLOW -->
            <div id="metabolicLogicFlow" style="margin-top: 30px;">
                <div class="glass-card" style="border-top: 6px solid var(--accent-primary);">
                    <div class="card-header">
                        <i class="fas fa-project-diagram"></i>
                        <h3>Protocol Biological Lifecycle</h3>
                    </div>
                    <div class="flow-container" id="logicFlowContainer">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 2: ANALYSIS -->
        <section id="analysis" class="dashboard-section">
            <div class="section-header">
                <h1>Bio-Metric Analysis</h1>
                <p>Your strengths, weaknesses, and nutritional needs</p>
            </div>

            <div class="grid-2">
                <div class="glass-card">
                    <div class="card-header">
                        <i class="fas fa-check-circle" style="color: var(--accent-primary)"></i>
                        <h3>Your Strengths</h3>
                    </div>
                    <ul class="bullet-list" id="strengthsList"></ul>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <i class="fas fa-exclamation-triangle" style="color: var(--accent-red)"></i>
                        <h3>Areas to Improve</h3>
                    </div>
                    <ul class="bullet-list" id="weaknessesList"></ul>
                </div>
            </div>

            <div class="grid-2">
                <div class="glass-card">
                    <div class="card-header">
                        <i class="fas fa-plus-circle" style="color: var(--accent-secondary)"></i>
                        <h3>Nutrient Optimization</h3>
                    </div>
                    <ul class="bullet-list" id="nutrientsList"></ul>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <i class="fas fa-ban" style="color: var(--accent-red)"></i>
                        <h3>Physiological Triggers (Avoid)</h3>
                    </div>
                    <ul class="bullet-list" id="avoidList"></ul>
                </div>
            </div>

            <!-- NEW SECTION: SUPPLEMENTS -->
            <div class="glass-card" style="margin-top: 25px;">
                <div class="card-header">
                    <i class="fas fa-capsules" style="color: var(--accent-tertiary)"></i>
                    <h3>Supplemental Adherence Protocol</h3>
                </div>
                <div class="meal-grid" id="supplementGrid">
                    <!-- Injected via JS -->
                </div>
            </div>
        </section>

        <!-- SECTION 3: MEALS -->
        <section id="meals" class="dashboard-section">
            <div class="section-header">
                <h1>Your Meal Plan</h1>
                <p>Optimized meals with exact macros and timing</p>
            </div>

            <div class="glass-card" style="margin-bottom: 25px;">
                <div class="card-header">
                    <i class="fas fa-fire"></i>
                    <h3>Calories by Meal</h3>
                </div>
                <div class="chart-container-sm">
                    <canvas id="mealCaloriesChart"></canvas>
                </div>
            </div>

            <div class="glass-card" style="margin-bottom: 25px;">
                <div class="card-header">
                    <i class="fas fa-bullseye"></i>
                    <h3>Strategy Points</h3>
                </div>
                <ul class="bullet-list" id="strategyList"></ul>
            </div>

            <div class="swiper-wrapper">
                <div class="swiper-arrow prev" onclick="scrollSwiper('mealGrid', -1)" style="display: none;"><i
                        class="fas fa-chevron-left"></i></div>
                <div class="meal-grid" id="mealGrid">
                    <!-- Injected via JS -->
                </div>
                <div class="swiper-arrow next" onclick="scrollSwiper('mealGrid', 1)" style="display: none;"><i
                        class="fas fa-chevron-right"></i></div>
            </div>

            <!-- EXPERT NOTES AREA -->
            <div id="expertNotesSection" style="margin-top: 30px;">
                <!-- Injected via JS -->
            </div>
        </section>

        <!-- SECTION 5: PROGRESS -->
        <section id="progress" class="dashboard-section">
            <div class="section-header">
                <h1>Progress Projection</h1>
                <p>What to expect over the next 4 weeks</p>
            </div>

            <div class="glass-card" style="margin-bottom: 25px;">
                <div class="card-header">
                    <i class="fas fa-chart-area"></i>
                    <h3>Weekly Progress Metrics</h3>
                </div>
                <div class="chart-container-lg">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <div class="grid-2">
                <div class="glass-card">
                    <div class="card-header">
                        <i class="fas fa-weight"></i>
                        <h3>Body Composition Changes</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="bodyChart"></canvas>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <i class="fas fa-radar"></i>
                        <h3>Health Radar</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <i class="fas fa-trophy"></i>
                    <h3>Milestones</h3>
                </div>
                <div class="milestone-list" id="milestoneList"></div>
            </div>
            <!-- NEW PROTOCOL GATEWAY (Moved inside progress for modularity) -->
            <div id="newProtocol" style="margin-top: 40px; text-align: center; padding-bottom: 40px; width: 100%;">
                <div class="glass-card"
                    style="background: linear-gradient(135deg, #0891b2 0%, #0ea5e9 100%); border: none; padding: 30px; box-shadow: 0 20px 50px rgba(8, 145, 178, 0.2); border-radius: 30px;">
                    <h2
                        style="color: #000; font-weight: 900; font-size: 1.8rem; margin-bottom: 12px; letter-spacing: -0.5px;">
                        Evolve Your Strategy</h2>
                    <p style="color: rgba(0,0,0,0.8); font-size: 1rem; margin-bottom: 25px; font-weight: 600;">Push your
                        metabolic performance even further with a fresh protocol.</p>
                    <a href="/diet/create" class="stat-card"
                        style="background: #000; color: #fff; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; padding: 15px 30px; border-radius: 100px; font-weight: 800; font-size: 1.1rem; cursor: pointer; border: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: auto; margin: 0 auto;">
                        <i class="fas fa-plus"></i>
                        NEW PROTOCOL
                    </a>
                </div>
            </div>
        </section>

        <!-- SECTION 6: NEARBY EXPERTS (MAP) -->
        <section id="experts" class="dashboard-section">
            <div class="section-header">
                <h1>Experts Near You</h1>
                <p>Locate elite nutritionists and clinics in your vicinity</p>
            </div>

            <div class="glass-card"
                style="padding: 0; overflow: hidden; height: 60vh; min-height: 500px; position: relative; border-radius: 30px;">
                <!-- Map Container -->
                <div id="map" style="width: 100%; height: 100%;"></div>

                <!-- Modern Search Bar Overlay -->
                <div class="map-search-wrapper">
                    <div class="map-search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="mapSearchInput" placeholder="Search location or clinic..."
                            onkeypress="if(event.key === 'Enter') window.clinicManager.manualSearch()">
                        <button onclick="window.clinicManager.manualSearch()">GO</button>
                    </div>
                </div>

                <!-- Map Mode Toggle -->
                <div class="map-mode-toggle">
                    <button id="modeStandard" class="active"
                        onclick="window.clinicManager.setStyle('light')">Standard</button>
                    <button id="modeSatellite" onclick="window.clinicManager.setStyle('satellite')">Satellite</button>
                </div>

                <!-- Location Loading State -->
                <div id="mapRadar" class="radar-scanner"
                    style="opacity: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(5px);">
                    <div class="radar-label" id="radarLabel"
                        style="background: var(--accent-primary); color: white; border: none; padding: 10px 25px;">
                        SCANNING...</div>
                </div>

                <!-- Info Panel (Floating) -->
                <div class="map-floating-panel collapsed" id="mapFloatingPanel">
                    <div class="panel-header"
                        onclick="document.getElementById('mapFloatingPanel').classList.toggle('collapsed')">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-satellite-dish"></i>
                            <span>Live Detection</span>
                        </div>
                    </div>
                    <div id="expertList" class="expert-list-mini">
                        <div class="list-placeholder">Searching for biomarkers...</div>
                    </div>
                </div>

                <!-- Locate Me Button -->
                <button class="map-locate-btn" onclick="window.clinicManager.locateUser()">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>

            <!-- Expert Details Grid -->
            <div id="expertDetailsGrid" class="meal-grid" style="margin-top: 30px;">
                <!-- Injected via JS -->
            </div>
        </section>
    </main>

    <script src="/static/js/strict_auth.js"></script>

    <!-- NOTIFICATION SETTINGS MODAL -->
    <div id="notificationSettingsModal" class="modal">
        <div class="modal-content glass-card" style="max-width: 500px;">
            <div class="modal-header">
                <div class="header-icon"><i class="fas fa-clock"></i></div>
                <h2>Customize Reminders</h2>
                <p>Adjust meal times to your schedule</p>
            </div>

            <div id="notifSettingsContent">
                <div class="loading-state" style="padding: 40px; text-align: center;">
                    <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--accent-primary);"></i>
                    <p style="margin-top: 15px;">Fetching your plan...</p>
                </div>
            </div>

            <div class="modal-footer"
                style="padding: 20px; display: flex; flex-direction: column; gap: 15px; margin-top: auto;">
                <button class="btn btn-primary" onclick="saveNotificationSettings()"
                    style="width: 100%; padding: 16px; font-size: 1.1rem; border-radius: 14px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                    Save Schedule
                </button>

                <div style="display: flex; gap: 10px; width: 100%;">
                    <button class="btn btn-secondary" onclick="resetToDefaultTimings()"
                        style="flex: 1; border: none; background: transparent; color: var(--accent-orange); font-size: 0.9rem;">
                        Reset to Default
                    </button>
                    <button class="btn btn-secondary" onclick="closeDietModal('notificationSettingsModal')"
                        style="flex: 1; border: 1px solid var(--glass-border); color: var(--text-secondary); border-radius: 12px;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PLAN SWITCHER MODAL -->
    <div id="planSwitcherModal" class="modal">
        <div class="modal-content glass-card" style="max-width: 600px; width: 90%;">
            <div class="modal-header">
                <div class="header-icon"><i class="fas fa-history"></i></div>
                <h2>Switch Diet Plan</h2>
                <p>Select from your previously saved plans</p>
            </div>

            <div id="planSwitcherContent"
                style="padding: 20px; overflow-y: auto; max-height: 50vh; overflow-x: hidden;">
                <div class="loading-state" style="padding: 40px; text-align: center;">
                    <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--accent-primary);"></i>
                    <p style="margin-top: 15px;">Loading your history...</p>
                </div>
            </div>

            <div class="modal-footer" style="padding: 20px; border-top: 1px solid var(--glass-border);">
                <button class="btn btn-secondary" onclick="closeDietModal('planSwitcherModal')"
                    style="width: 100%; border-radius: 12px; border: 1px solid var(--glass-border);">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- GENERIC CONFIRMATION MODAL -->
    <div id="confirmModal" class="modal" style="z-index: 10000;">
        <div class="modal-content glass-card" style="max-width: 400px; width: 90%; text-align: center;">
            <div class="modal-header" style="justify-content: center; padding-bottom: 5px;">
                <div class="header-icon"
                    style="background: var(--accent-orange); width: 60px; height: 60px; margin: 0 auto;">
                    <i class="fas fa-question" style="font-size: 1.8rem;"></i>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px 30px;">
                <h3 id="confirmTitle" style="margin-bottom: 10px; color: var(--text-primary);">Are you sure?</h3>
                <p id="confirmMessage" style="color: var(--text-secondary); line-height: 1.5;">Do you want to proceed
                    with this action?</p>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 15px; padding: 25px;">
                <button class="btn btn-secondary" id="confirmCancelBtn" style="min-width: 100px;">Cancel</button>
                <button class="btn btn-primary" id="confirmOkBtn" style="min-width: 100px;">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Navigation
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerMenu');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function scrollSwiper(containerId, direction) {
            const container = document.getElementById(containerId);
            const scrollAmount = container.clientWidth * 0.8 * direction;
            container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }

        function updateSwiperArrows(containerId) {
            if (window.innerWidth > 480) return; // Desktop exclusion

            const container = document.getElementById(containerId);
            if (!container) return;

            const wrapper = container.closest('.swiper-wrapper');
            if (!wrapper) return;

            const prevBtn = wrapper.querySelector('.swiper-arrow.prev');
            const nextBtn = wrapper.querySelector('.swiper-arrow.next');

            if (!prevBtn || !nextBtn) return;

            // Show arrows only if scrollable
            const isScrollable = container.scrollWidth > container.clientWidth;

            if (isScrollable) {
                // Left Arrow: Hide if at start
                prevBtn.style.display = container.scrollLeft <= 5 ? 'none' : 'flex';
                prevBtn.style.opacity = container.scrollLeft <= 5 ? '0' : '1';

                // Right Arrow: Hide if at end
                const atEnd = container.scrollLeft + container.clientWidth >= container.scrollWidth - 5;
                nextBtn.style.display = atEnd ? 'none' : 'flex';
                nextBtn.style.opacity = atEnd ? '0' : '1';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }
        }

        function showSection(sectionId, el) {
            const sections = document.querySelectorAll('.dashboard-section');
            const navLinks = document.querySelectorAll('.nav-link');
            const headerTitle = document.getElementById('headerSectionTitle');

            // Update Header Title for mobile
            if (headerTitle) {
                headerTitle.innerText = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
            }

            // If on mobile, close sidebar after clicking
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar.classList.contains('active')) {
                    toggleMobileSidebar();
                }
            }

            // 1. OUTGOING: Fade out current active section
            const currentActive = document.querySelector('.dashboard-section.active');
            if (currentActive && currentActive.id !== sectionId) {
                currentActive.classList.add('fading-out');

                // Remove active status after transition
                setTimeout(() => {
                    currentActive.classList.remove('active');
                    currentActive.classList.remove('fading-out');
                    currentActive.style.display = ''; // Clear inline styles
                    currentActive.style.opacity = '';
                    currentActive.style.transform = '';
                }, 300); // Matches CSS transition duration
            }

            // Update Nav Links Active State
            navLinks.forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-link').forEach(n => n.classList.remove('active'));

            if (el) el.classList.add('active');

            // Sync bottom nav if sidebar link clicked or vice versa
            const bottomNavLink = document.querySelector(`.bottom-nav-link[onclick*="'${sectionId}'"]`);
            if (bottomNavLink) bottomNavLink.classList.add('active');
            const sidebarNavLink = document.querySelector(`.sidebar .nav-link[onclick*="'${sectionId}'"]`);
            if (sidebarNavLink) sidebarNavLink.classList.add('active');

            // 2. INCOMING: Show target section with overlap
            const target = document.getElementById(sectionId);

            // Small delay to ensure smooth cross-fade feeling
            setTimeout(() => {
                // Reset state in case it was fading out
                target.classList.remove('fading-out');

                // Force display block via inline style temporarily to allow transition to start
                target.style.display = 'block';

                // Trigger Reflow (Critical for animation to play)
                void target.offsetWidth;

                // Activate
                target.classList.add('active');

                // Clean up inline styles so CSS classes take over
                target.style.display = '';
                target.style.opacity = '';
                target.style.transform = '';
            }, 50);

            // Scroll to top of main content smoothly
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Initialize arrows on mobile
            setTimeout(() => {
                updateSwiperArrows('statsRow');
                updateSwiperArrows('mealGrid');
            }, 500);
        }

        // Add scroll listeners for boundary detection
        document.getElementById('statsRow').addEventListener('scroll', () => updateSwiperArrows('statsRow'));
        document.getElementById('mealGrid').addEventListener('scroll', () => updateSwiperArrows('mealGrid'));

        // Load Data
        document.addEventListener('DOMContentLoaded', async () => {
            let data = null;
            let isSaved = false;

            // Check URL for "new" parameter - this means we JUST generated a plan
            const urlParams = new URLSearchParams(window.location.search);
            const isNewGeneration = urlParams.get('new') === '1';
            const localData = localStorage.getItem('fullDietData');

            console.log('[Dashboard] isNewGeneration:', isNewGeneration, 'hasLocalData:', !!localData);

            // PRIORITY 1: If ?new=1 is in URL, ALWAYS use localStorage (just generated)
            if (isNewGeneration && localData) {
                try {
                    data = JSON.parse(localData);
                    isSaved = false;
                    console.log('✨ [NEW] Loaded freshly generated plan from LocalStorage');

                    // Clean up URL without reloading
                    window.history.replaceState({}, '', '/diet/dashboard');
                } catch (e) {
                    console.error('LocalStorage parse failed:', e);
                }
            }

            // PRIORITY 2: If no new plan param, check database for saved plan
            if (!data) {
                try {
                    const response = await fetch('/api/diet/active_plan');
                    const apiData = await response.json();

                    if (apiData.status === 'success' && apiData.plan_data) {
                        data = apiData.plan_data;
                        isSaved = true;
                        console.log('📁 [SAVED] Loaded plan from Database');
                    }
                } catch (e) {
                    console.warn('DB Fetch failed:', e);
                }
            }

            // PRIORITY 3: Fallback to localStorage if no DB data
            if (!data && localData) {
                try {
                    data = JSON.parse(localData);
                    isSaved = false;
                    console.log('📦 [FALLBACK] Loaded from LocalStorage');
                } catch (e) {
                    console.warn('LocalStorage fallback failed:', e);
                }
            }

            // 4. Handle No Data
            if (!data) {
                document.getElementById('errorBanner').textContent = "🔄 No data found. Please generate a new plan.";
                document.getElementById('errorBanner').style.display = 'block';
                return;
            }

            // 5. Update Save Button (Hide if already saved in DB)
            const saveBtn = document.getElementById('savePlanBtn');
            if (saveBtn) {
                if (isSaved) {
                    saveBtn.style.display = 'none'; // Already saved
                } else {
                    saveBtn.style.display = 'flex'; // Needs saving
                }
            }

            console.log("Dashboard Data:", data);

            // Populate Mobile Header Info
            const mobileUserInfo = document.getElementById('mobile-user-info');
            if (mobileUserInfo && data.user_overview) {
                const name = data.user_overview.name || 'User';
                const archetype = data.user_overview.archetype || 'Analysis';
                mobileUserInfo.innerHTML = `<span>${name}</span> | <span style="opacity: 0.8; font-weight: 500;">${archetype}</span>`;
            }

            // USER OVERVIEW STATS
            const userInfo = data.user_overview || {};
            const statsRow = document.getElementById('statsRow');
            const statItems = [
                { value: userInfo.daily_calories_target || '2000', label: 'Daily Kcal' },
                { value: (userInfo.bmi || 22).toFixed(1), label: 'BMI Index' },
                { value: `${userInfo.protein_target_g || 100}g`, label: 'Protein' },
                { value: `${userInfo.carbs_target_g || 250}g`, label: 'Carbs' },
                { value: `${userInfo.fat_target_g || 60}g`, label: 'Fats' },
                { value: `${userInfo.fiber_target_g || 30}g`, label: 'Fiber' },
                { value: `${userInfo.water_target_l || 3}L`, label: 'Hydration' }
            ];
            statsRow.innerHTML = ''; // Clear previous
            statItems.forEach(s => {
                statsRow.innerHTML += `
                    <div class="stat-card">
                        <div class="stat-value">${s.value}</div>
                        <div class="stat-label">${s.label}</div>
                    </div>`;
            });

            // METABOLIC LOGIC FLOW
            const mlf = data.metabolic_logic_flow || [];
            const flowContainer = document.getElementById('logicFlowContainer');
            if (flowContainer && mlf.length > 0) {
                flowContainer.innerHTML = mlf.map((step, i) => `
                    <div class="flow-step">
                        <span class="phase">${step.phase || 'Phase'}</span>
                        <span class="trigger">${step.trigger}</span>
                        <span class="process">${step.process}</span>
                        <span class="outcome"><i class="fas fa-bullseye"></i> ${step.outcome}</span>
                    </div>
                `).join('');
            }

            // BIO-COMPUTATIONAL LOGIC SIGNATURE
            const reasoningEl = document.getElementById('aiReasoning');
            if (data.reasoning_signature) {
                // If the signature contains bullet markers, split and render
                const points = data.reasoning_signature.split('\n').filter(p => p.trim());
                reasoningEl.innerHTML = `<ul class="bullet-list">${points.map(p => `<li style="margin-bottom: 10px; font-weight: 500;">${p.replace(/^[-*•]\s+/, '')}</li>`).join('')}</ul>`;
            } else {
                reasoningEl.textContent = "Strategic protocol active. Bio-metrics aligned.";
            }

            // QUICK TIPS
            const tips = data.quick_tips || [];
            const tipsGrid = document.getElementById('tipsGrid');
            if (tipsGrid) {
                tips.forEach(t => {
                    tipsGrid.innerHTML += `
                        <div class="tip-card">
                            <span class="icon">${t.icon || '💡'}</span>
                            <span class="text">${t.tip || ''}</span>
                        </div>`;
                });
            }

            // MACRO PIE CHART
            const macroData = data.bio_analysis?.macro_breakdown;
            if (macroData) {
                new Chart(document.getElementById('macroChart'), {
                    type: 'doughnut',
                    data: {
                        labels: macroData.labels || ['Protein', 'Carbs', 'Fats'],
                        datasets: [{
                            data: macroData.values || [30, 50, 20],
                            backgroundColor: macroData.colors || ['#00ff88', '#00d4ff', '#ff6b6b'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#333',  // Dark text for light theme
                                    font: { family: 'Outfit', size: 12, weight: 600 },
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }

            // ENERGY CHART
            const scheduleData = data.diet_protocol?.daily_schedule;
            if (scheduleData) {
                new Chart(document.getElementById('energyChart'), {
                    type: 'line',
                    data: {
                        labels: scheduleData.labels || ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
                        datasets: [{
                            label: 'Energy Level',
                            data: scheduleData.energy_level || [30, 85, 70, 60, 80, 40],
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.15)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#00ff88'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#333', font: { family: 'Outfit', weight: 600 } }
                            }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Energy %', color: '#666' },
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { color: '#666' },
                                min: 0,
                                max: 100
                            },
                            x: {
                                title: { display: true, text: 'Time of Day', color: '#666' },
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { color: '#666' }
                            }
                        }
                    }
                });
            }

            // STRENGTHS & WEAKNESSES
            const bio = data.bio_analysis || {};
            renderBulletList('strengthsList', bio.strengths);
            renderBulletList('weaknessesList', bio.weaknesses);

            // NUTRIENTS & AVOID
            renderNutrientList('nutrientsList', bio.key_nutrients);
            renderAvoidList('avoidList', bio.avoid_foods);

            // SUPPLEMENTS
            const supplements = data.supplement_protocol || [];
            const supplementGrid = document.getElementById('supplementGrid');
            if (supplementGrid) {
                supplementGrid.innerHTML = '';
                supplements.forEach(s => {
                    const subPointsHtml = (s.bullets || []).map(p => `<li>${p}</li>`).join('');
                    supplementGrid.innerHTML += `
                        <div class="meal-card" style="border-color: var(--accent-tertiary); background: rgba(124, 58, 237, 0.02); min-height: auto;">
                            <div class="meal-name" style="font-size: 1.1rem; margin-bottom: 5px;">${s.name || 'Supplement'}</div>
                            <div style="font-size: 0.85rem; font-weight: 800; color: var(--accent-tertiary); margin-bottom: 12px;">Protocol: ${s.dosage || '...'}</div>
                            <div class="bullet-content">
                                <ul style="margin-top: 5px;">${subPointsHtml}</ul>
                            </div>
                        </div>`;
                });
            }

            // MEAL CALORIES CHART
            const mealCalData = data.diet_protocol?.meal_calories_chart;
            if (mealCalData) {
                new Chart(document.getElementById('mealCaloriesChart'), {
                    type: 'bar',
                    data: {
                        labels: mealCalData.labels || ['Breakfast', 'Snack', 'Lunch', 'Snack', 'Dinner'],
                        datasets: [{
                            label: 'Calories',
                            data: mealCalData.values || [400, 150, 500, 150, 450],
                            backgroundColor: mealCalData.colors || ['#00ff88', '#00d4ff', '#7c3aed', '#ff6b6b', '#ffd93d'],
                            borderRadius: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: { color: '#333', font: { family: 'Outfit', weight: 600 } }
                            }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Calories (kcal)', color: '#666' },
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { color: '#666' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#666', font: { weight: 600 } }
                            }
                        }
                    }
                });
            }

            // STRATEGY POINTS
            const strategyList = document.getElementById('strategyList');
            const strategyPoints = data.diet_protocol?.strategy_points || [];
            strategyPoints.forEach((p, i) => {
                strategyList.innerHTML += `
                    <li class="bullet-item">
                        <span class="bullet-icon"><i class="fas fa-bullseye"></i></span>
                        <div class="bullet-content"><p>${p}</p></div>
                    </li>`;
            });

            // MEAL CARDS
            const meals = data.diet_protocol?.meals || [];
            const mealGrid = document.getElementById('mealGrid');
            mealGrid.innerHTML = '';
            meals.forEach(m => {
                const ingredientsHtml = (m.bullets || []).map(i => `<li>${i}</li>`).join('');
                const logicHtml = (m.science_logic || []).map(l => `<li>${l}</li>`).join('');
                const macros = m.macros || { P: 0, C: 0, F: 0 };
                const mealName = m.name || 'Meal';
                const mealKeywords = mealName.toLowerCase();
                let imgUrl = 'https://images.unsplash.com/photo-1490645935967-10de6ba17061?auto=format&fit=crop&w=800&q=80'; // Default healthy food

                if (mealKeywords.includes('breakfast') || mealKeywords.includes('morning') || mealKeywords.includes('oats') || mealKeywords.includes('egg')) {
                    imgUrl = 'https://images.unsplash.com/photo-1484723091739-30a097e8f929?auto=format&fit=crop&w=800&q=80';
                } else if (mealKeywords.includes('lunch') || mealKeywords.includes('salad') || mealKeywords.includes('bowl')) {
                    imgUrl = 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800&q=80';
                } else if (mealKeywords.includes('dinner') || mealKeywords.includes('steak') || mealKeywords.includes('salmon') || mealKeywords.includes('curry')) {
                    imgUrl = 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=800&q=80';
                } else if (mealKeywords.includes('snack') || mealKeywords.includes('fruit') || mealKeywords.includes('nuts')) {
                    imgUrl = 'https://images.unsplash.com/photo-1567620905732-2d1ec7bb7445?auto=format&fit=crop&w=800&q=80';
                }

                mealGrid.innerHTML += `
                    <div class="meal-card" style="background-image: url('${imgUrl}')">
                        <div class="meal-card-overlay"></div>
                        <div class="meal-time-badge">⏰ ${m.time || ''}</div>
                        <div class="meal-card-content">
                            <div class="meal-name">${mealName}</div>
                            <div class="macro-container">
                                <span class="macro-pill protein" style="background: rgba(22, 163, 74, 0.1); color: var(--accent-primary); padding: 5px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 700;">P: ${macros.P}g</span>
                                <span class="macro-pill carbs" style="background: rgba(14, 165, 233, 0.1); color: var(--accent-secondary); padding: 5px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 700;">C: ${macros.C}g</span>
                                <span class="macro-pill fat" style="background: rgba(250, 204, 21, 0.1); color: var(--accent-yellow); padding: 5px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 700;">F: ${macros.F}g</span>
                            </div>
                            <ul class="meal-items" style="list-style: none; display: flex; flex-direction: column; gap: 8px;">
                                ${m.bullets.slice(0, 3).map(i => `
                                    <li style="font-size: 0.85rem; color: var(--text-secondary); padding-left: 18px; position: relative; line-height: 1.4; font-weight: 500;">
                                        <span style="position: absolute; left: 0; color: var(--accent-primary);">•</span> ${i}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>`;
            });

            // Note: Section 4 "Execution" was removed in favor of Section 1 "Bio-Flow"

            // EXPERT NOTES
            const notes = data.expert_notes || [];
            const notesTarget = document.getElementById('expertNotesSection');
            if (notesTarget) {
                notesTarget.innerHTML = `
                    <div class="glass-card" style="border-left: 5px solid var(--accent-pink);">
                        <div class="card-header">
                            <i class="fas fa-user-md" style="color: var(--accent-pink);"></i>
                            <h3>Performance Mastery Notes</h3>
                        </div>
                        <ul class="bullet-list">
                            ${notes.map(n => `
                                <li class="bullet-item">
                                    <span class="bullet-icon">💡</span>
                                    <div class="bullet-content"><p style="font-size: 1rem; color: var(--text-primary);">${n}</p></div>
                                </li>`).join('')}
                        </ul>
                    </div>`;
            }

            // PERFORMANCE PROGRESS CHART
            const perfData = data.performance_projection?.week_by_week;
            if (perfData) {
                new Chart(document.getElementById('progressChart'), {
                    type: 'line',
                    data: {
                        labels: perfData.labels || ['W1', 'W2', 'W3', 'W4', 'W8', 'W12'],
                        datasets: [
                            { label: 'Energy Index', data: perfData.energy_index || [65, 75, 85, 95, 98, 99], borderColor: '#00ff88', tension: 0.4, borderWidth: 3 },
                            { label: 'Cognitive Clarity', data: perfData.cognitive_clarity || [60, 70, 80, 90, 95, 98], borderColor: '#00d4ff', tension: 0.4, borderWidth: 3 },
                            { label: 'Hormonal Balance', data: perfData.hormonal_balance || [50, 65, 80, 90, 95, 96], borderColor: '#7c3aed', tension: 0.4, borderWidth: 3 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#000', font: { family: 'Outfit', size: 12 } } } },
                        scales: {
                            y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: 'rgba(0,0,0,0.5)' } },
                            x: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: 'rgba(0,0,0,0.5)' } }
                        }
                    }
                });
            }

            // BODY COMPOSITION PROJECTOR
            const bodyProject = data.performance_projection?.week_by_week;
            if (bodyProject) {
                new Chart(document.getElementById('bodyChart'), {
                    type: 'bar',
                    data: {
                        labels: bodyProject.labels || ['W1', 'W2', 'W4', 'W12'],
                        datasets: [
                            { label: 'Fat Loss', data: bodyProject.fat_loss_kg || [1, 2, 4, 8], backgroundColor: '#ff6b6b' },
                            { label: 'Muscle Gain', data: bodyProject.muscle_gain_kg || [0.2, 0.5, 1, 3], backgroundColor: '#00ff88' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: window.innerWidth > 480, // Hide legend on tiny screens to save space
                                labels: { color: '#000', font: { size: 10 } }
                            }
                        },
                        scales: {
                            y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: 'rgba(0,0,0,0.5)', font: { size: 10 } } },
                            x: { grid: { display: false }, ticks: { color: 'rgba(0,0,0,0.5)', font: { size: 10 } } }
                        },
                        layout: { padding: { bottom: 10 } }
                    }
                });
            }

            // ADVANCED HEALTH RADAR
            const radarData = data.performance_projection?.health_radar;
            if (radarData) {
                new Chart(document.getElementById('radarChart'), {
                    type: 'radar',
                    data: {
                        labels: radarData.categories || ['Energy', 'Digestion', 'Sleep', 'Strength', 'Recovery', 'Focus'],
                        datasets: [
                            { label: 'Current', data: radarData.current || [5, 4, 6, 5, 4, 5], borderColor: '#ff6b6b', backgroundColor: 'rgba(255, 107, 107, 0.2)', borderWidth: 2 },
                            { label: 'Peak', data: radarData.projected || [9, 8, 9, 9, 8, 9], borderColor: '#00ff88', backgroundColor: 'rgba(0, 255, 136, 0.2)', borderWidth: 2 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: window.innerWidth > 480,
                                labels: { color: '#000', font: { size: 10 } }
                            }
                        },
                        scales: {
                            r: {
                                grid: { color: 'rgba(0,0,0,0.1)' },
                                pointLabels: {
                                    color: '#000',
                                    font: { size: window.innerWidth <= 480 ? 9 : 11, weight: 'bold' },
                                    backdropPadding: 2
                                },
                                ticks: { display: false },
                                suggestedMin: 0,
                                suggestedMax: 10
                            }
                        }
                    }
                });
            }

            // BIO-MARKER MILESTONES
            const milestones = data.performance_projection?.milestones || [];
            const milestoneList = document.getElementById('milestoneList');
            milestoneList.innerHTML = '';
            milestones.forEach(m => {
                const subPointsHtml = (m.points || []).map(p => `<li>${p}</li>`).join('');
                milestoneList.innerHTML += `
                    <div class="milestone-item" style="display: block; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span class="milestone-week">WEEK ${m.week || ''}</span>
                            <span class="milestone-icon"><i class="fas fa-dna"></i></span>
                        </div>
                        <div class="bullet-content">
                            <ul style="margin: 0;">${subPointsHtml}</ul>
                        </div>
                    </div>`;
            });
        });

        // Helper Functions
        function renderBulletList(id, items) {
            const el = document.getElementById(id);
            if (!items) return;
            el.innerHTML = '';
            items.forEach(item => {
                const subPointsHtml = (item.points || []).map(p => `<li>${p}</li>`).join('');
                el.innerHTML += `
                    <li class="bullet-item">
                        <span class="bullet-icon">${item.icon || '•'}</span>
                        <div class="bullet-content">
                            <h4>${item.title || ''}</h4>
                            <ul>${subPointsHtml}</ul>
                        </div>
                    </li>`;
            });
        }

        function renderNutrientList(id, items) {
            const el = document.getElementById(id);
            if (!items) return;
            el.innerHTML = '';
            items.forEach(item => {
                const subPointsHtml = (item.points || []).map(p => `<li>${p}</li>`).join('');
                el.innerHTML += `
                    <li class="bullet-item">
                        <span class="bullet-icon"><i class="fas fa-dna"></i></span>
                        <div class="bullet-content">
                            <h4 style="color: var(--accent-primary);">${item.name || ''}</h4>
                            <ul>${subPointsHtml}</ul>
                            <div style="font-size: 0.8rem; margin-top: 8px; color: var(--text-muted);">Source Matrix: ${item.source || 'Standard'}</div>
                        </div>
                    </li>`;
            });
        }

        function renderAvoidList(id, items) {
            const el = document.getElementById(id);
            if (!items) return;
            el.innerHTML = '';
            items.forEach(item => {
                const subPointsHtml = (item.reasons || []).map(p => `<li>${p}</li>`).join('');
                el.innerHTML += `
                    <li class="bullet-item">
                        <span class="bullet-icon">🚫</span>
                        <div class="bullet-content">
                            <h4 style="color: var(--accent-red);">${item.food || ''}</h4>
                            <ul>${subPointsHtml}</ul>
                            <div style="font-size: 0.8rem; margin-top: 8px; color: var(--accent-primary);">Swap: ${item.swap || 'None'}</div>
                        </div>
                    </li>`;
            });
        }


        // Save Plan to Database
        async function savePlan() {
            const rawData = localStorage.getItem('fullDietData');
            if (!rawData) {
                alert('No generated plan session found to save.');
                return;
            }
            const data = JSON.parse(rawData);

            const btn = document.getElementById('savePlanBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="nav-icon"><i class="fas fa-spinner fa-spin"></i></span><span>Saving...</span>';

            try {
                const response = await fetch('/api/diet/save_plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan_data: data,
                        duration_type: data.duration_type || 'weekly'
                    })
                });

                const result = await response.json();

                if (result.error) {
                    if (result.error.includes('Login')) {
                        alert('Your session has expired. Please login again to save your plan.');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(result.error);
                }

                btn.innerHTML = '<span class="nav-icon"><i class="fas fa-check-circle" style="color: #00ff88;"></i></span><span style="color: #00ff88; font-weight: 800;">Saved in Cloud</span>';
                btn.style.background = 'rgba(0, 255, 136, 0.2)';
                btn.style.borderColor = '#00ff88';

                // Mark as saved so dashboard knows to fetch from DB next time
                localStorage.setItem('planSaved', 'true');
                // Keep data as backup but mark as saved
                // localStorage.removeItem('fullDietData');

                setTimeout(() => {
                    btn.style.display = 'none'; // Hide as it's now permanent in DB
                }, 2000);

            } catch (error) {
                console.error('Save error:', error);
                alert('Cloud save failed: ' + error.message);
                btn.innerHTML = originalHTML;
            }
        }

        // ============== NOTIFICATION SYSTEM ==============
        let notificationsEnabled = false;

        // Toggle notifications on/off
        async function toggleNotifications() {
            const icon = document.getElementById('notificationIcon');
            const label = document.getElementById('notificationLabel');
            const toggle = document.getElementById('notificationToggle');

            if (!window.notificationManager) {
                showNotificationToast('⚠️ Error', 'Notification manager not loaded');
                return;
            }

            if (notificationsEnabled) {
                // Disable notifications
                label.textContent = 'Disabling...';
                toggle.style.pointerEvents = 'none';

                await window.notificationManager.disable();

                notificationsEnabled = false;
                toggle.classList.remove('enabled');
                icon.className = 'fas fa-bell-slash';
                label.textContent = 'Enable Reminders';
                document.getElementById('openNotifSettingsBtn').style.display = 'none';
                toggle.style.pointerEvents = '';

            } else {
                // Enable notifications
                label.textContent = 'Enabling...';
                toggle.style.pointerEvents = 'none';

                const success = await window.notificationManager.enable();

                if (success) {
                    notificationsEnabled = true;
                    toggle.classList.add('enabled');
                    icon.className = 'fas fa-bell';
                    label.textContent = 'Reminders ON';
                    document.getElementById('openNotifSettingsBtn').style.display = 'flex';
                } else {
                    icon.className = 'fas fa-bell-slash';
                    label.textContent = 'Enable Reminders';
                    document.getElementById('openNotifSettingsBtn').style.display = 'none';
                }
                toggle.style.pointerEvents = '';
            }
        }

        // Check notification status on page load
        async function checkNotificationStatus() {
            if (!window.notificationManager) return;

            try {
                const status = await window.notificationManager.getStatus();

                if (status && status.enabled && status.registered_devices > 0) {
                    notificationsEnabled = true;
                    const icon = document.getElementById('notificationIcon');
                    const label = document.getElementById('notificationLabel');
                    const toggle = document.getElementById('notificationToggle');

                    toggle.classList.add('enabled');
                    icon.className = 'fas fa-bell';
                    label.textContent = 'Reminders ON';
                    document.getElementById('openNotifSettingsBtn').style.display = 'flex';

                    console.log(`[Notifications] Active: ${status.scheduled_reminders} meal reminders scheduled`);
                } else {
                    document.getElementById('openNotifSettingsBtn').style.display = 'none';
                }
            } catch (e) {
                console.log('[Notifications] Status check failed:', e);
            }
        }

        // Show toast notification
        function showNotificationToast(title, message) {
            if (window.notificationManager) {
                window.notificationManager.showToast(title, message);
            }
        }

        // Modal Helpers
        function openDietModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('show');
            }
        }

        function closeDietModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        }

        // ============== NOTIFICATION CUSTOMIZATION ==============
        let currentCustomTimings = {};

        async function openNotificationSettings() {
            openDietModal('notificationSettingsModal');
            const content = document.getElementById('notifSettingsContent');

            content.innerHTML = `
                <div class="loading-state" style="padding: 40px; text-align: center;">
                    <i class="fas fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--accent-primary);"></i>
                    <p style="margin-top: 15px;">Loading your schedule...</p>
                </div>`;

            try {
                // Get plan data and current preferences
                let planDataStr = localStorage.getItem('fullDietData');
                let planData = null;

                if (planDataStr) {
                    planData = JSON.parse(planDataStr);
                } else {
                    // Fallback: Fetch from API if not in local storage
                    try {
                        const planResp = await fetch('/api/diet/active_plan');
                        const planJson = await planResp.json();

                        if (planJson.status === 'success' && planJson.plan_data) {
                            planData = planJson.plan_data;
                            // Update local storage so we don't fetch every time
                            localStorage.setItem('fullDietData', JSON.stringify(planData));
                        }
                    } catch (err) {
                        console.error('Error fetching active plan:', err);
                    }
                }

                if (!planData) {
                    content.innerHTML = `<p style="color: var(--accent-red); text-align: center;">No active diet plan found. Please create a plan first.</p>`;
                    return;
                }
                const meals = planData.diet_protocol?.meals || [];

                const prefs = await window.notificationManager.getPreferences();
                if (!prefs || prefs.error) {
                    throw new Error(prefs?.error || 'Could not fetch preferences from server');
                }
                currentCustomTimings = prefs.custom_timings || {};

                if (meals.length === 0) {
                    content.innerHTML = `<p style="text-align: center;">No meals found in your plan.</p>`;
                    return;
                }

                // Robust time parser helper
                const formatTimeForInput = (timeStr) => {
                    if (!timeStr) return "";
                    const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                    if (!match) return timeStr; // Already 24h or unknown

                    let hours = parseInt(match[1], 10);
                    const minutes = match[2];
                    const modifier = (match[3] || "").toUpperCase();

                    if (modifier === 'PM' && hours < 12) hours += 12;
                    if (modifier === 'AM' && hours === 12) hours = 0;

                    return `${String(hours).padStart(2, '0')}:${minutes}`;
                };

                // Enforce container visibility
                let html = '<div class="notif-settings-list" style="margin-top: 0; width: 100%; display: block;">';
                meals.forEach((meal, index) => {
                    const mealName = meal.name;
                    // Use index to guarantee unique IDs (avoids collision like "Pre Workout" vs "Pre-Workout")
                    const safeName = `meal-card-${index}`;
                    const escapedMealName = mealName.replace(/'/g, "\\'"); // Escape single quotes for onclick

                    const defaultTime = meal.time;
                    const currentTime = currentCustomTimings[mealName] || defaultTime;
                    const timeValue = formatTimeForInput(currentTime);
                    const isCustom = currentCustomTimings[mealName] && currentCustomTimings[mealName] !== defaultTime;

                    // EXPANDABLE CARD DESIGN (Mobile Friendly) - Explicit Colors
                    html += `
                        <div class="notif-settings-item" style="padding: 0; border-radius: 16px; margin-bottom: 12px; background: #ffffff; border: 1px solid rgba(0,0,0,0.08); overflow: hidden; width: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.03);">
                            
                            <!-- HEADER: Always Visible, Click to Expand -->
                            <div class="notif-card-header" onclick="toggleMealCard('${safeName}')" 
                                style="padding: 14px 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; background: #ffffff; transition: background 0.2s;">
                                <div class="notif-meal-info" style="display: flex; align-items: center; gap: 12px;">
                                    <div class="notif-icon-circle" style="width: 36px; height: 36px; font-size: 1rem; display: flex; align-items: center; justify-content: center; background: rgba(8, 145, 178, 0.1); border-radius: 50%; color: var(--accent-primary);">
                                        <i class="fas fa-bowl-food"></i>
                                    </div>
                                    <div class="notif-meal-details">
                                        <div class="notif-meal-name" style="font-size: 1rem; font-weight: 700; color: var(--text-primary);">${mealName}</div>
                                        <div class="notif-time-preview" style="font-size: 0.8rem; color: var(--text-secondary);">
                                            <i class="far fa-clock"></i> ${currentTime} 
                                            ${isCustom ? '<span style="color: var(--accent-primary); font-weight:600;">(Custom)</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="expand-icon" id="icon-${safeName}" style="color: var(--text-muted); transition: transform 0.3s ease;">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>

                            <!-- BODY: Hidden by Default, Contains Controls -->
                            <div class="notif-card-body" id="body-${safeName}" style="display: none; padding: 15px; border-top: 1px solid rgba(0,0,0,0.05); background: rgba(0,0,0,0.01);">
                                <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                                    
                                    <!-- Time Picker -->
                                    <div style="flex: 1; min-width: 120px;">
                                        <label style="font-size: 0.75rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 5px;">REMINDER TIME</label>
                                        <input type="time" class="notif-time-input" data-meal="${mealName}" value="${timeValue}"
                                            style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--glass-border); font-family: 'Outfit', sans-serif; font-size: 1rem;">
                                    </div>

                                    <!-- Send Test Button -->
                                    <div style="flex-shrink: 0; align-self: flex-end;">
                                         <button onclick="forceFireNotification('${escapedMealName}')" 
                                            style="padding: 10px 16px; background: var(--accent-primary); border-radius: 10px; color: white; border: none; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                            <i class="fas fa-paper-plane"></i> Test
                                        </button>
                                    </div>
                                </div>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 10px; margin-bottom: 0;">
                                    <i class="fas fa-info-circle"></i> Notification will be sent at this time daily.
                                </p>
                            </div>
                        </div>`;
                });
                html += '</div>';

                // Add Script for Toggle Logic if not already present
                if (!window.toggleMealCard) {
                    window.toggleMealCard = function (id) {
                        const body = document.getElementById(`body-${id}`);
                        const icon = document.getElementById(`icon-${id}`);

                        if (body.style.display === 'none') {
                            body.style.display = 'block';
                            icon.style.transform = 'rotate(180deg)';
                            icon.style.color = 'var(--accent-primary)';
                        } else {
                            body.style.display = 'none';
                            icon.style.transform = 'rotate(0deg)';
                            icon.style.color = 'var(--text-muted)';
                        }
                    };
                }

                // COLLAPSIBLE TROUBLESHOOTING
                html += `
                    <details style="margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
                        <summary style="cursor: pointer; font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; outline: none;">
                            <i class="fas fa-wrench" style="margin-right: 5px;"></i> Troubleshooting
                        </summary>
                        <div style="margin-top: 15px; background: rgba(0,0,0,0.02); padding: 15px; border-radius: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="testNotificationConnection()" class="btn btn-outline" style="padding: 10px; font-size: 0.85rem; background: white;">
                                    <i class="fas fa-wifi"></i> Test Net
                                </button>
                                <button onclick="fixNotificationConnection()" class="btn btn-outline" style="padding: 10px; font-size: 0.85rem; border-color: var(--accent-tertiary); color: var(--accent-tertiary); background: white;">
                                    <i class="fas fa-sync"></i> Re-Link
                                </button>
                            </div>
                            <button class="btn btn-secondary" id="notifTestBtn" onclick="sendTestNotification()"
                                style="width: 100%; margin-top: 10px; font-size: 0.85rem; background: white;">
                                <i class="fas fa-bell" style="margin-right: 8px;"></i> Send Test Push
                            </button>
                            <div id="debugStatus" style="font-size: 0.8rem; margin-top: 10px; text-align: center; min-height: 20px;"></div>
                        </div>
                    </details>
                `;

                content.innerHTML = html;

            } catch (error) {
                console.error('Failed to load settings:', error);
                content.innerHTML = `<p style="color: var(--accent-red); text-align: center;">Error loading settings. Please try again.</p>`;
            }
        }

        async function saveNotificationSettings() {
            const inputs = document.querySelectorAll('.notif-time-input');
            const newTimings = {};

            inputs.forEach(input => {
                const mealName = input.getAttribute('data-meal');
                const timeValue = input.value;

                if (timeValue) {
                    // Convert "15:30" to "3:30 PM"
                    let [hours, minutes] = timeValue.split(':');
                    hours = parseInt(hours, 10);
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // the hour '0' should be '12'
                    newTimings[mealName] = `${hours}:${minutes} ${ampm}`;
                }
            });

            try {
                const saveBtn = document.querySelector('#notificationSettingsModal .btn-primary');
                const originalText = saveBtn.innerText;
                saveBtn.innerText = 'Saving...';
                saveBtn.disabled = true;

                const result = await window.notificationManager.updatePreferences({
                    custom_timings: newTimings
                });

                if (result.success) {
                    showNotificationToast('✅ Saved', 'Meal reminders rescheduled!');
                    closeDietModal('notificationSettingsModal');
                    // Refresh status to show new schedule count
                    checkNotificationStatus();
                } else {
                    throw new Error(result.error || 'Failed to update preferences');
                }
            } catch (error) {
                console.error('Save settings error:', error);
                showNotificationToast('❌ Error', error.message || 'Failed to save settings');
            } finally {
                const saveBtn = document.querySelector('#notificationSettingsModal .btn-primary');
                saveBtn.innerText = 'Save Schedule';
                saveBtn.disabled = false;
            }
        }

        // Debug Handlers
        async function testNotificationConnection() {
            const statusEl = document.getElementById('debugStatus');
            statusEl.innerHTML = '<span style="color: var(--accent-primary);"><i class="fas fa-spinner fa-spin"></i> Sending test...</span>';

            try {
                const result = await window.notificationManager.sendTest();
                if (result) {
                    statusEl.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check"></i> Test sent! Check for pop-up.</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #dc2626;"><i class="fas fa-times"></i> Test failed. Try "Fix Connection".</span>';
                }
            } catch (e) {
                statusEl.innerHTML = `<span style="color: #dc2626;">Error: ${e.message}</span>`;
            }
        }

        async function fixNotificationConnection() {
            const statusEl = document.getElementById('debugStatus');
            statusEl.innerHTML = '<span style="color: var(--accent-tertiary);"><i class="fas fa-spinner fa-spin"></i> Resetting ID...</span>';

            try {
                // Use the new HARD RESET method which explicitly deletes the bad token
                const success = await window.notificationManager.hardReset();

                if (success) {
                    statusEl.innerHTML = '<span style="color: #16a34a;"><i class="fas fa-check"></i> <b>Fixed!</b> ID Refreshed.</span>';
                    showNotificationToast('✅ Connection Fixed', 'Your mobile is now using the correct Key.');

                    // Refresh visual status
                    checkNotificationStatus();
                } else {
                    statusEl.innerHTML = '<span style="color: #dc2626;">Reset failed. Try reloading.</span>';
                }
            } catch (e) {
                console.error(e);
                statusEl.innerHTML = `<span style="color: #dc2626;">Error: ${e.message}</span>`;
            }
        }
        function toggleDebugLogs() {
            const el = document.getElementById('liveLogs');
            if (el.style.display === 'none') {
                el.style.display = 'block';
                console.log('--- Log Viewer Started ---');
                console.log('User Agent:', navigator.userAgent);
                console.log('Notification permission:', Notification.permission);
                // Dump current token
                if (window.notificationManager && window.notificationManager.currentToken) {
                    console.log('Current Token:', window.notificationManager.currentToken.substring(0, 15) + '...');
                } else {
                    console.warn('No active token found in manager.');
                }
            } else {
                el.style.display = 'none';
            }
        }

        // --- CUSTOM CONFIRM MODAL LOGIC ---
        function showConfirmModal(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const msgEl = document.getElementById('confirmMessage');
                const okBtn = document.getElementById('confirmOkBtn');
                const cancelBtn = document.getElementById('confirmCancelBtn');

                titleEl.textContent = title;
                msgEl.textContent = message;

                const close = (result) => {
                    modal.classList.remove('show');
                    resolve(result);
                };

                okBtn.onclick = () => close(true);
                cancelBtn.onclick = () => close(false);

                // Click outside to cancel
                modal.onclick = (e) => {
                    if (e.target === modal) close(false);
                };

                modal.classList.add('show');
            });
        }

        async function forceFireNotification(mealName) {
            const confirmed = await showConfirmModal(
                'Send Notification?',
                `Send immediate test notification for "${mealName}"?`
            );

            if (!confirmed) return;

            showNotificationToast('Sending...', `Triggering ${mealName}`);
            // ... rest of function ...


            try {
                const response = await fetch('/api/notifications/debug/force_fire', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ meal_name: mealName })
                });
                const result = await response.json();

                if (result.success) {
                    showNotificationToast('✅ Sent', result.message);
                } else {
                    showNotificationToast('❌ Failed', result.error);
                }
            } catch (e) {
                console.error(e);
                showNotificationToast('❌ Error', 'Network or server error');
            }
        }

        async function sendTestNotification() {
            const btn = document.getElementById('notifTestBtn');
            const originalHTML = btn.innerHTML;

            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                btn.disabled = true;

                const token = window.notificationManager ? window.notificationManager.currentToken : null;

                const response = await fetch('/api/notifications/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
                const result = await response.json();

                if (result.success) {
                    showNotificationToast('🔔 Test Sent', 'Check your device for a notification!');
                } else {
                    throw new Error(result.error || 'Failed to send test');
                }
            } catch (error) {
                console.error('Test error:', error);
                showNotificationToast('❌ Fail', error.message);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        async function resetToDefaultTimings() {
            const confirmed = await showConfirmModal(
                'Reset Schedule?',
                'Reset all meal times to their original plan defaults?'
            );

            if (!confirmed) return;

            const btn = document.querySelector('button[onclick="resetToDefaultTimings()"]');

            try {
                const result = await window.notificationManager.updatePreferences({
                    custom_timings: {} // Clear overrides
                });

                if (result.success) {
                    showNotificationToast('✅ Reset', 'Back to original meal plan times!');
                    closeDietModal('notificationSettingsModal');
                    checkNotificationStatus();
                } else {
                    throw new Error(result.error || 'Reset failed');
                }
            } catch (error) {
                console.error('Reset error:', error);
                showNotificationToast('❌ Error', error.message);
            }
        }

        // Initialize notification status after DOM loads
        setTimeout(checkNotificationStatus, 1500);
    </script>
    <!-- Diety AI Assistant -->
    <div id="dietyContainer" class="diety-container">
        <div id="dietyChatWindow" class="diety-chat-window">
            <div class="diety-header">
                <img src="/static/img/logo.svg" alt="Diety">
                <span>Diety</span>
                <button id="dietyClose"><i class="fas fa-times"></i></button>
            </div>
            <div id="dietyMessages" class="diety-messages"></div>
            <div class="diety-input">
                <input type="text" id="dietyInput" placeholder="How can I help you?">
                <button id="dietySend" onclick="window.dietyAssistant.sendMessage()"><i
                        class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div id="dietyToggle" class="diety-toggle">
            <img src="/static/img/logo.svg" alt="Diety">
            <div id="dietyBadge" class="diety-badge"></div>
        </div>
    </div>


    <script src="/static/js/assistant_manager.js" defer></script>
    <script src="/static/js/i18n.js"></script>
    <script>
        async function openPlanSwitcher() {
            const modal = document.getElementById('planSwitcherModal');
            modal.classList.add('show');
            const content = document.getElementById('planSwitcherContent');

            try {
                const response = await fetch('/api/diet/my_plans');
                const data = await response.json();

                if (!data.plans || data.plans.length === 0) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><i class="fas fa-ghost" style="font-size: 3rem; margin-bottom: 20px; display: block;"></i>No other plans found.</div>';
                    return;
                }

                content.innerHTML = `
                    <div class="plan-list" style="display: flex; flex-direction: column; gap: 12px;">
                        ${data.plans.map(plan => {
                    const date = new Date(plan.created_at).toLocaleDateString();
                    const isActive = plan.is_active;
                    return `
                                <div class="plan-item ${isActive ? 'active' : ''}" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; border: 1px solid var(--glass-border); border-radius: 14px; background: rgba(0,0,0,0.02);">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="width: 40px; height: 40px; background: var(--gradient-main); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: black;">
                                            <i class="fas fa-calendar-alt"></i>
                                        </div>
                                        <div>
                                            <div style="font-weight: 700;">${plan.duration_type.toUpperCase()} Plan</div>
                                            <div style="font-size: 0.8rem; color: var(--text-muted);">Created ${date}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        ${isActive ? '<span class="active-badge" data-i18n="plan_active">ACTIVE</span>' :
                            `<button class="edit-profile-btn" onclick="activatePlanFromDash('${plan.id}')" style="padding: 5px 10px;" data-i18n="plan_activate">Activate</button>`}
                                        <button class="edit-profile-btn" onclick="viewPlanFromDash('${plan.id}')" style="padding: 5px 10px;" data-i18n="plan_view">View</button>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            } catch (e) {
                content.innerHTML = '<div style="color: var(--accent-red); padding: 20px;">Error loading plans.</div>';
            }
        }

        async function activatePlanFromDash(planId) {
            try {
                const response = await fetch(`/api/diet/set_active/${planId}`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                }
            } catch (e) { console.error(e); }
        }

        async function viewPlanFromDash(planId) {
            try {
                const response = await fetch(`/api/diet/plan/${planId}`);
                const data = await response.json();
                if (data.plan) {
                    localStorage.setItem('fullDietData', JSON.stringify(data.plan.plan_data));
                    localStorage.setItem('planSaved', 'true');
                    window.location.reload();
                }
            } catch (e) { console.error(e); }
        }

        function closeDietModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        }
    </script>
    <!-- Diety AI Assistant -->
    <div id="dietyContainer" class="diety-container">
        <div id="dietyChatWindow" class="diety-chat-window">
            <div class="diety-header">
                <img src="/static/img/logo.svg" alt="Diety">
                <span>Diety</span>
                <button id="dietyClose"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>
            <div id="dietyMessages" class="diety-messages"></div>
            <div class="diety-input">
                <input type="text" id="dietyInput" placeholder="How can I help you?">
                <button id="dietySend" onclick="window.dietyAssistant.sendMessage()"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg></button>
            </div>
        </div>
        <div id="dietyToggle" class="diety-toggle">
            <img src="/static/img/logo.svg" alt="Diety">
            <div id="dietyBadge" class="diety-badge"></div>
        </div>
    </div>
    <script src="/static/js/assistant_manager.js" defer></script>
</body>


</html>