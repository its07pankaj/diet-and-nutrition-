<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logging in... | DietNotify</title>
    <link rel="icon" type="image/svg+xml" href="/static/img/logo.svg">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0a0f;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .loader-container {
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(34, 197, 94, 0.2);
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 8px;
        }

        p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .error {
            color: #ef4444;
            display: none;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="loader-container">
        <div class="spinner"></div>
        <h2>Signing you in...</h2>
        <p>Please wait a moment</p>
        <p class="error" id="errorMsg"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://irgaogiswwgysrnqgxnw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyZ2FvZ2lzd3dneXNybnFneG53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4Mzg0NTIsImV4cCI6MjA4NTQxNDQ1Mn0.yjORsAZ46qlSYl-dzz24YIH_j8XT-EF34B72J4gVdqo';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function handleCallback() {
            try {
                // Get the session from URL hash (OAuth callback)
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) throw error;

                if (session) {
                    // Sync with Flask backend
                    const response = await fetch('/api/auth/sync_session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: session.user.email,
                            user_id: session.user.id,
                            name: session.user.user_metadata?.full_name || session.user.email.split('@')[0]
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        window.location.href = data.redirect;
                    } else {
                        throw new Error(data.error || 'Failed to sync session');
                    }
                } else {
                    // No session - redirect to login
                    window.location.href = '/login';
                }
            } catch (err) {
                console.error('Auth callback error:', err);
                document.getElementById('errorMsg').textContent = err.message;
                document.getElementById('errorMsg').style.display = 'block';

                setTimeout(() => {
                    window.location.href = '/login';
                }, 3000);
            }
        }

        // Handle the callback
        handleCallback();
    </script>
</body>

</html>